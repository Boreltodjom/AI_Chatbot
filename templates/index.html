<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chatbot</title>
  <style>
    :root {
      --bg: #f0f2f5;
      --chat-bg: #ffffff;
      --text: #222;
      --user-msg: #667eea;
      --bot-msg: #e9ecef;
      --header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    body.dark {
      --bg: #1e1e1e;
      --chat-bg: #2c2c2c;
      --text: #eee;
      --user-msg: #4a6ee0;
      --bot-msg: #3a3a3a;
      --header-bg: linear-gradient(135deg, #444 0%, #222 100%);
    }
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      transition: background 0.3s;
    }
    .chat-container {
      background: var(--chat-bg);
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      width: 95%;
      max-width: 600px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background 0.3s;
    }
    .chat-header {
      background: var(--header-bg);
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .toggle-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: white;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 8px;
    }
    .message.user { justify-content: flex-end; }
    .message.bot { justify-content: flex-start; }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .avatar.bot { background: #667eea; color: white; }
    .avatar.user { background: #ccc; color: #222; }
    .message-content {
      padding: 12px 16px;
      border-radius: 15px;
      max-width: 75%;
      line-height: 1.5;
      word-wrap: break-word;
      background: var(--bot-msg);
      color: var(--text);
    }
    .message.user .message-content {
      background: var(--user-msg);
      color: white;
    }
    .message img {
      max-width: 240px;
      border-radius: 10px;
      margin-top: 8px;
    }
    .input-container {
      display: flex;
      align-items: center;
      padding: 10px;
      border-top: 1px solid #ddd;
      gap: 6px;
      background: var(--chat-bg);
      transition: background 0.3s;
    }
    .text-input {
      flex: 1;
      border: 1px solid #ccc;
      border-radius: 20px;
      padding: 10px;
      outline: none;
      resize: none;
      font-size: 14px;
      background: var(--chat-bg);
      color: var(--text);
    }
    .send-btn, .mic-btn, .file-label {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .send-btn:hover, .mic-btn:hover, .file-label:hover { background: #5a6fd8; }
    .file-input { display: none; }
    .image-preview { text-align: center; margin-top: 8px; }
    .image-preview img { max-width: 100px; border-radius: 8px; border: 1px solid #ccc; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      ğŸ¤– AI Chatbot
      <button class="toggle-btn" onclick="toggleTheme()">ğŸŒ™</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="input-container">
      <label for="imageInput" class="file-label">ğŸ“</label>
      <input type="file" id="imageInput" name="image" class="file-input" accept="image/*">
      <textarea id="messageInput" class="text-input" placeholder="Type a message..."></textarea>
      <button onclick="sendMessage()" class="send-btn">â¤</button>
      <button onclick="startListening()" class="mic-btn">ğŸ™ï¸</button>
    </div>
    <div class="image-preview" id="imagePreview" style="display:none;">
      <img id="previewImg" src="" alt="Preview">
      <button onclick="removeImage()">âŒ Remove</button>
    </div>
  </div>

  <script>
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const imageInput = document.getElementById("imageInput");
    const previewImg = document.getElementById("previewImg");
    const imagePreview = document.getElementById("imagePreview");

    let introShown = false;
    let recognition;
    // Store user's language preference
    let userLanguage = 'en'; // Default

    // Theme toggle
    function toggleTheme() {
      document.body.classList.toggle("dark");
      const btn = document.querySelector(".toggle-btn");
      btn.textContent = document.body.classList.contains("dark") ? "ğŸŒ" : "ğŸŒ™";
    }

    // Preview selected image
    imageInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          previewImg.src = e.target.result;
          imagePreview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    function removeImage() {
      imageInput.value = "";
      previewImg.src = "";
      imagePreview.style.display = "none";
    }

    function addMessage(content, isUser = false) {
      const msg = document.createElement("div");
      msg.className = `message ${isUser ? "user" : "bot"}`;
      const avatar = document.createElement("div");
      avatar.className = `avatar ${isUser ? "user" : "bot"}`;
      avatar.textContent = isUser ? "ğŸ‘¤" : "ğŸ¤–";
      const bubble = document.createElement("div");
      bubble.className = "message-content";
      bubble.innerHTML = isUser ? content : marked.parse(content);
      msg.appendChild(avatar);
      msg.appendChild(bubble);
      chatMessages.appendChild(msg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage() {
      const message = messageInput.value; // Get original message (including potential leading/trailing spaces)
      const strippedMessage = message.trim(); // For logic checks
      const hasImage = imageInput.files.length > 0;

      if (!strippedMessage && !hasImage) return; // Prevent sending completely empty content

      // Add user message bubble only if there's text to show
      if (strippedMessage) {
        addMessage(message, true); // Show original message including spaces if user typed them
      }

      // Indicate image upload visually if an image is present
      if (hasImage) {
        // If no text message was shown, still indicate the image action
        if (!strippedMessage) {
             addMessage("ğŸ“· Image uploaded", true);
        }
        // If there was text, the text bubble already indicates the action
      }

      const formData = new FormData();
      // Send message only if it exists (even if just spaces)
      if (message !== undefined && message !== null) {
          formData.append("message", message);
      }
      if (hasImage) formData.append("image", imageInput.files[0]);

      messageInput.value = "";
      removeImage();

      try {
        const res = await fetch("/chat", { method: "POST", body: formData });
        const data = await res.json();
        addMessage(data.response, false);
      } catch (err) {
        console.error("Fetch error:", err); // Log the actual error for debugging
        addMessage("âŒ Error connecting to server.", false);
      }
    }

    // Voice recognition with auto language detection based on userLanguage preference
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      // Set initial language based on userLanguage variable or browser
       // Detect browser language as fallback if userLanguage not explicitly set by button yet
       const browserLang = navigator.language.toLowerCase();
       let initialLang = 'en-US';
       if (userLanguage === 'fr' || (userLanguage === 'en' && browserLang.includes('fr'))) {
           initialLang = 'fr-FR';
       }
      recognition.lang = initialLang;
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = e => {
        const transcript = e.results[0][0].transcript;
        messageInput.value = transcript;
        sendMessage();
      };

      recognition.onerror = e => {
        if (e.error === 'not-allowed') {
          addMessage("âš ï¸ Microphone access denied. Please allow it in settings.", false);
        } else {
            console.warn("Speech recognition error:", e.error);
        }
      };
    } else {
        console.log("Speech recognition not supported in this browser.");
    }

    function startListening() {
      if (recognition) {
        try {
          // Update lang before starting based on current userLanguage preference
          recognition.lang = userLanguage === 'fr' ? 'fr-FR' : 'en-US';
          recognition.start();
        } catch (err) {
          console.warn("Speech recognition already running or blocked.");
          addMessage("ğŸ™ï¸ Voice input is busy or blocked. Please try again.", false);
        }
      } else {
        // Fallback message if SpeechRecognition API is not available
        addMessage("ğŸ™ï¸ Voice input not supported in this browser.", false);
      }
    }

    // Enter to send
    messageInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Language selection screen
    window.onload = () => {
      // Show language selection prompt
      addMessage("ğŸŒ Welcome! Please choose your preferred language:", false);
      const buttonContainer = document.createElement("div");
      buttonContainer.style.margin = "10px 0";
      buttonContainer.style.textAlign = "center"; // Center the buttons

      const btnEn = document.createElement("button");
      btnEn.textContent = "ğŸ‡¬ğŸ‡§ English";
      // Apply consistent styling
      Object.assign(btnEn.style, {
        margin: "0 5px",
        padding: "10px 15px",
        border: "none",
        borderRadius: "8px",
        backgroundColor: "#667eea",
        color: "white",
        cursor: "pointer",
        fontSize: "16px"
      });
      btnEn.onclick = () => selectLanguage("en");

      const btnFr = document.createElement("button");
      btnFr.textContent = "ğŸ‡«ğŸ‡· FranÃ§ais";
      // Apply consistent styling
       Object.assign(btnFr.style, {
        margin: "0 5px",
        padding: "10px 15px",
        border: "none",
        borderRadius: "8px",
        backgroundColor: "#667eea",
        color: "white",
        cursor: "pointer",
        fontSize: "16px"
      });
      btnFr.onclick = () => selectLanguage("fr");

      buttonContainer.appendChild(btnEn);
      buttonContainer.appendChild(btnFr);
      chatMessages.appendChild(buttonContainer);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    function selectLanguage(lang) {
      // Remove language buttons
      const buttons = document.querySelector("div[style*='margin: 10px 0'], div[style*='text-align: center']");
      if (buttons) buttons.remove();

      // Store the user's language preference
      userLanguage = lang;

      // Send intro in selected language
      let intro;
      if (lang === "en") {
        intro = (
          "ğŸ‘‹ Hello! Iâ€™m your AI Assistant.\n\n" +
          "Hereâ€™s what I can do:\n" +
          "1. ğŸ’¬ Chat with you naturally\n" +
          "2. ğŸ“· Analyze uploaded images and answer questions\n" +
          "3. ğŸ™ï¸ Accept voice input (on supported browsers)\n\n" +
          "Ask me anything to get started!"
        );
      } else {
        intro = (
          "ğŸ‘‹ Bonjour ! Je suis votre assistant IA.\n\n" +
          "Voici ce que je peux faire :\n" +
          "1. ğŸ’¬ Discuter avec vous naturellement\n" +
          "2. ğŸ“· Analyser les images tÃ©lÃ©chargÃ©es et rÃ©pondre Ã  vos questions\n" +
          "3. ğŸ™ï¸ Accepter l'entrÃ©e vocale (sur les navigateurs pris en charge)\n\n" +
          "Posez-moi n'importe quelle question pour commencer !"
        );
      }
      addMessage(intro, false);
      introShown = true;
    }
  </script>
</body>
</html>
